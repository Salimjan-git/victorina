<!-- templates/quizzes/detail.html -->
{% extends "base.html" %}

{% block title %}{{ quiz.title }} - Викторина{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Quiz Header -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-question-circle me-2 text-primary"></i>
                        {{ quiz.title }}
                    </h1>
                    
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <span class="badge bg-primary fs-6">
                            <i class="fas fa-book me-1"></i>
                            {{ quiz.subject.name|default:"Без предмета" }}
                        </span>
                        
                        <span class="badge bg-{% if quiz.status == 'active' %}success
                                            {% elif quiz.status == 'upcoming' %}warning
                                            {% elif quiz.status == 'completed' %}secondary
                                            {% else %}info{% endif %} fs-6">
                            {% if quiz.status == 'active' %}
                                <i class="fas fa-play-circle me-1"></i> Фаъол
                            {% elif quiz.status == 'upcoming' %}
                                <i class="fas fa-clock me-1"></i> Омадаистода
                            {% elif quiz.status == 'completed' %}
                                <i class="fas fa-check-circle me-1"></i> Анҷомёфта
                            {% else %}
                                <i class="fas fa-pause-circle me-1"></i> {{ quiz.status|title }}
                            {% endif %}
                        </span>
                        
                        <span class="badge bg-info fs-6">
                            <i class="fas fa-layer-group me-1"></i>
                            {{ quiz.level_type|upper }}
                        </span>
                    </div>
                </div>
                
                {% if user.role == 'teacher' or user.role == 'admin' %}
                <div class="btn-group">
                    <a href="{% url 'quiz_edit' quiz.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit"></i> Таҳрир
                    </a>
                    <a href="{% url 'quiz_results' quiz.id %}" class="btn btn-outline-success">
                        <i class="fas fa-chart-bar"></i> Натиҷаҳо
                    </a>
                </div>
                {% endif %}
            </div>
            
            {% if quiz.description %}
            <div class="alert alert-light border mb-4">
                <h6 class="fw-bold mb-2">
                    <i class="fas fa-info-circle me-2 text-primary"></i>Тавсиф:
                </h6>
                <p class="mb-0">{{ quiz.description|linebreaks }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="row">
        <!-- Left Column: Quiz Information -->
        <div class="col-lg-8 mb-4">
            <!-- Quiz Stats -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-primary text-center h-100">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-primary mb-2">{{ quiz.time_limit }}</div>
                            <h6 class="text-muted mb-0">
                                <i class="fas fa-clock me-1"></i>Дақиқа
                            </h6>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card border-success text-center h-100">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-success mb-2">{{ questions.count }}</div>
                            <h6 class="text-muted mb-0">
                                <i class="fas fa-question-circle me-1"></i>Саволҳо
                            </h6>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card border-warning text-center h-100">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-warning mb-2">{{ quiz.pass_percentage }}%</div>
                            <h6 class="text-muted mb-0">
                                <i class="fas fa-trophy me-1"></i>Мин. ҳад
                            </h6>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card border-info text-center h-100">
                        <div class="card-body">
                            <div class="display-6 fw-bold text-info mb-2">{{ quiz.max_attempts }}</div>
                            <h6 class="text-muted mb-0">
                                <i class="fas fa-redo me-1"></i>Кӯшишҳо
                            </h6>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Time Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Вақти викторина
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted mb-1">
                                    <i class="fas fa-play-circle me-2 text-success"></i>
                                    Вақти оғоз:
                                </h6>
                                <p class="fs-5 fw-bold">{{ quiz.start_time|date:"d.m.Y H:i" }}</p>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted mb-1">
                                    <i class="fas fa-flag-checkered me-2 text-danger"></i>
                                    Вақти анҷом:
                                </h6>
                                <p class="fs-5 fw-bold">{{ quiz.end_time|date:"d.m.Y H:i" }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Time Progress Bar -->
                    {% if quiz.status == 'active' %}
                    <div class="progress mb-2" style="height: 10px;">
                        {% now "U" as current_time %}
                        {% with quiz.start_time|date:"U" as start_time %}
                        {% with quiz.end_time|date:"U" as end_time %}
                        {% with current_time|add:"0" as current %}
                            {% widthratio current|add:"-"|add:start_time end_time|add:"-"|add:start_time 100 as progress %}
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: {{ progress }}%"></div>
                        {% endwith %}
                        {% endwith %}
                        {% endwith %}
                    </div>
                    <small class="text-muted">
                        Викторина фаъол аст. Барои иштирок вақт мондааст.
                    </small>
                    {% endif %}
                </div>
            </div>
            
            <!-- Level Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Сатҳи викторина
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">Навъи сатҳ:</h6>
                            <p class="fs-5 fw-bold">{{ quiz.get_level_type_display }}</p>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-muted mb-1">Ҳудуди сатҳҳо:</h6>
                            <p class="fs-5 fw-bold">{{ quiz.start_level }} - {{ quiz.end_level }}</p>
                        </div>
                    </div>
                    
                    {% if user.role == 'student' %}
                    <div class="mt-3 p-3 rounded 
                        {% if can_access %}bg-success bg-opacity-10 border border-success
                        {% else %}bg-danger bg-opacity-10 border border-danger{% endif %}">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                {% if can_access %}
                                <i class="fas fa-check-circle fa-2x text-success"></i>
                                {% else %}
                                <i class="fas fa-times-circle fa-2x text-danger"></i>
                                {% endif %}
                            </div>
                            <div>
                                <h6 class="mb-1">
                                    {% if can_access %}
                                    Шумо иҷозати иштирок доред!
                                    {% else %}
                                    Шумо иҷозати иштирок надоред!
                                    {% endif %}
                                </h6>
                                <small class="text-muted">
                                    {% if can_access %}
                                    Сатҳи шумо: {{ request.user.profile.current_level }}. Шумо метавонед дар ин викторина иштирок кунед.
                                    {% else %}
                                    Сатҳи шумо: {{ request.user.profile.current_level }}. Ин викторина барои сатҳҳои {{ quiz.start_level }}-{{ quiz.end_level }} пешбинӣ шудааст.
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Questions Preview -->
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol me-2"></i>Саволҳо ({{ questions.count }})
                    </h5>
                    
                    {% if user.role == 'teacher' or user.role == 'admin' %}
                    <a href="{% url 'question_create' quiz.id %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus-circle me-1"></i> Саволи нав
                    </a>
                    {% endif %}
                </div>
                
                <div class="card-body">
                    {% if questions %}
                    <div class="list-group">
                        {% for question in questions %}
                        <div class="list-group-item border-0 py-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-2">
                                        {{ forloop.counter }}. {{ question.text|truncatewords:20 }}
                                    </h6>
                                    
                                    <div class="d-flex gap-3">
                                        <small class="text-muted">
                                            <i class="fas fa-star me-1"></i>
                                            {{ question.points }} ҳаққ
                                        </small>
                                        
                                        <small class="text-muted">
                                            <i class="fas fa-question me-1"></i>
                                            {{ question.question_type }}
                                        </small>
                                        
                                        <small class="text-muted">
                                            <i class="fas fa-list-ol me-1"></i>
                                            {{ question.answers.count }} ҷавоб
                                        </small>
                                    </div>
                                </div>
                                
                                {% if user.role == 'teacher' or user.role == 'admin' %}
                                <div class="btn-group">
                                    <a href="{% url 'question_edit' question.id %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if question.hint %}
                            <div class="alert alert-warning mt-2 mb-0 p-2" style="font-size: 0.9em;">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Ишора:</strong> {{ question.hint }}
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if not forloop.last %}
                        <hr class="my-1 mx-3">
                        {% endif %}
                        
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Саволҳо вуҷуд надоранд</h5>
                        <p class="text-muted">Ҳанӯз ягон савол илова нашудааст</p>
                        
                        {% if user.role == 'teacher' or user.role == 'admin' %}
                        <a href="{% url 'question_create' quiz.id %}" class="btn btn-primary">
                            <i class="fas fa-plus-circle me-2"></i> Саволи аввалро илова кунед
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Right Column: Actions & Statistics -->
        <div class="col-lg-4">
            <!-- Action Card -->
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Амалҳо
                    </h5>
                </div>
                
                <div class="card-body">
                    <!-- For Students -->
                    {% if user.role == 'student' %}
                        {% if can_access and quiz.is_active %}
                            {% if has_attempted and attempts_remaining == 0 %}
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle me-2"></i>
                                Шумо ҳамаи кӯшишҳоро истифода кардед.
                            </div>
                            {% elif has_attempted and attempts_remaining > 0 %}
                            <div class="alert alert-warning mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-redo me-2"></i>
                                        Кӯшишҳои боқӣ: {{ attempts_remaining }}
                                    </div>
                                    <a href="{% url 'quiz_start' quiz.id %}" class="btn btn-warning btn-sm">
                                        <i class="fas fa-play me-1"></i> Аз нав оғоз
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2">
                                {% if not has_attempted or attempts_remaining > 0 %}
                                <a href="{% url 'quiz_start' quiz.id %}" class="btn btn-success btn-lg">
                                    <i class="fas fa-play-circle me-2"></i> 
                                    {% if has_attempted %}Аз нав оғоз{% else %}Оғоз кардан{% endif %}
                                </a>
                                {% endif %}
                                
                                {% if has_attempted %}
                                <a href="{% url 'my_results' %}" class="btn btn-outline-primary">
                                    <i class="fas fa-chart-bar me-2"></i> Натиҷаҳои ман
                                </a>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                {% if not can_access %}
                                Викторина барои сатҳи шумо дастрас нест.
                                {% elif not quiz.is_active %}
                                Викторина фаъол нест.
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    <!-- For Teachers/Admins -->
                    {% if user.role == 'teacher' or user.role == 'admin' %}
                    <div class="d-grid gap-2 mb-3">
                        <a href="{% url 'question_create' quiz.id %}" class="btn btn-primary">
                            <i class="fas fa-plus-circle me-2"></i> Саволи нав
                        </a>
                        <a href="{% url 'quiz_edit' quiz.id %}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i> Таҳрир кардан
                        </a>
                        <a href="{% url 'quiz_results' quiz.id %}" class="btn btn-outline-success">
                            <i class="fas fa-chart-bar me-2"></i> Натиҷаҳо
                        </a>
                    </div>
                    {% endif %}
                    
                    <hr class="my-3">
                    
                    <!-- Instructions -->
                    <div class="mb-3">
                        <h6 class="fw-bold mb-2">
                            <i class="fas fa-clipboard-list me-2 text-primary"></i>
                            Дастурҳо:
                        </h6>
                        <ul class="list-unstyled small text-muted">
                            <li class="mb-1">
                                <i class="fas fa-check-circle me-1 text-success"></i>
                                Вақт: {{ quiz.time_limit }} дақиқа
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-check-circle me-1 text-success"></i>
                                Кӯшишҳо: {{ quiz.max_attempts }} маротиба
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-check-circle me-1 text-success"></i>
                                Ҳадди ақал: {{ quiz.pass_percentage }}%
                            </li>
                            {% if quiz.quiz_mode %}
                            <li class="mb-1">
                                <i class="fas fa-check-circle me-1 text-success"></i>
                                Реҷа: {{ quiz.get_quiz_mode_display }}
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Card -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Омор
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-4 fw-bold text-primary">{{ total_participants }}</div>
                        <small class="text-muted">Иштирокчиён</small>
                    </div>
                    
                    <div class="text-center mb-3">
                        <div class="display-5 fw-bold text-success">{{ avg_score|floatformat:1 }}</div>
                        <small class="text-muted">Миёнаи натиҷа</small>
                    </div>
                    
                    {% if user.role == 'student' and has_attempted %}
                    <hr>
                    <h6 class="fw-bold mb-2">Натиҷаи шумо:</h6>
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-award me-2"></i>
                                Шумо анҷом додаед
                            </span>
                            <a href="{% url 'my_results' %}" class="btn btn-sm btn-outline-info">
                                Дидан
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Progress Bar for Average Score -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Миёнаи натиҷа:</small>
                            <small class="fw-bold">{{ avg_score|floatformat:1 }}</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" 
                                 style="width: {{ avg_score }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Time Status Card -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-hourglass-half me-2"></i>Вақт
                    </h5>
                </div>
                <div class="card-body">
                    {% now "d.m.Y H:i" as current_time %}
                    <div class="mb-2">
                        <small class="text-muted">Вақти ҷорӣ:</small>
                        <div class="fw-bold">{{ current_time }}</div>
                    </div>
                    
                    {% if quiz.is_active %}
                    <div class="alert alert-success py-2 mb-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle fa-lg me-2"></i>
                            <div>
                                <strong>Фаъол</strong>
                                <div class="small">Викторина дастрас аст</div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning py-2 mb-0">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock fa-lg me-2"></i>
                            <div>
                                <strong>Фаъол нест</strong>
                                <div class="small">Викторина дар дастрасӣ нест</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Back to List Button -->
    <div class="mt-4">
        <a href="{% url 'quiz_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Ба рӯйхати викторинаҳо
        </a>
    </div>
</div>

<style>
.sticky-top {
    position: -webkit-sticky;
    position: sticky;
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 1rem 0; }
    100% { background-position: 0 0; }
}

.list-group-item:hover {
    background-color: rgba(67, 97, 238, 0.05);
    border-left: 3px solid #4361ee;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-update time every minute
    function updateCurrentTime() {
        const now = new Date();
        const formattedTime = now.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        $('.fw-bold:contains("Вақти ҷорӣ:")').next().text(formattedTime);
    }
    
    setInterval(updateCurrentTime, 60000);
    
    // Check if quiz is still active
    function checkQuizStatus() {
        $.ajax({
            url: "{% url 'check_quiz_time' quiz.id %}",
            type: 'GET',
            success: function(data) {
                if (!data.is_active) {
                    // Reload page if quiz became inactive
                    location.reload();
                }
            }
        });
    }
    
    // Check every 30 seconds if user is on the page
    if ("{{ quiz.status }}" === 'active') {
        setInterval(checkQuizStatus, 30000);
    }
    
    // Tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}