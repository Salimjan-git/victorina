<!-- templates/quizzes/create.html -->
{% extends "base.html" %}

{% block title %}Эҷоди викторинаи нав{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #fff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .form-section-header {
        border-bottom: 2px solid #4361ee;
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .step-indicator {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .step {
        display: flex;
        align-items: center;
        flex: 1;
    }
    
    .step-number {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #e9ecef;
        color: #6c757d;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 0.75rem;
    }
    
    .step.active .step-number {
        background: #4361ee;
        color: white;
    }
    
    .step.completed .step-number {
        background: #28a745;
        color: white;
    }
    
    .step-line {
        flex: 1;
        height: 2px;
        background: #e9ecef;
        margin: 0 1rem;
    }
    
    .step-label {
        font-weight: 500;
        color: #6c757d;
    }
    
    .step.active .step-label {
        color: #4361ee;
        font-weight: 600;
    }
    
    .question-type-btn {
        padding: 1rem;
        text-align: center;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }
    
    .question-type-btn:hover {
        border-color: #4361ee;
        background: #f8f9fa;
    }
    
    .question-type-btn.active {
        border-color: #4361ee;
        background: rgba(67, 97, 238, 0.1);
    }
    
    .question-type-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #4361ee;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Progress Steps -->
    <div class="step-indicator">
        <div class="step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-label">Маълумоти асосӣ</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">Саволҳо</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">Танзимот</div>
        </div>
    </div>
    
    <h1 class="display-5 fw-bold mb-4">
        <i class="fas fa-plus-circle me-2 text-primary"></i>
        Эҷоди викторинаи нав
    </h1>
    
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" id="quizCreateForm" action="{% url 'quiz_create' %}">
        {% csrf_token %}
        
        <!-- Step 1: Basic Information -->
        <div class="form-section" id="step1-content">
            <div class="form-section-header">
                <h4 class="fw-bold text-primary">
                    <i class="fas fa-info-circle me-2"></i>
                    Маълумоти асосӣ
                </h4>
                <p class="text-muted mb-0">Маълумоти асосии викторинаро пур кунед</p>
            </div>
            
            <!-- Title -->
            <div class="mb-3">
                <label for="id_title" class="form-label fw-bold">Унвони викторина *</label>
                <input type="text" class="form-control form-control-lg" 
                       id="id_title" name="title" required
                       placeholder="Масалан: Тести математикаи ҳисоббарор">
                <div class="form-text">Унвони равшан ва муайян ба корбарон кӯмак мекунад</div>
            </div>
            
            <!-- Subject and Description -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_subject" class="form-label fw-bold">Фан</label>
                    <select class="form-select" id="id_subject" name="subject">
                        <option value="" selected>Без фан (ихтиёрӣ)</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% empty %}
                        <option disabled>Ягон фан вуҷуд надорад</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label for="id_quiz_mode" class="form-label fw-bold">Реҷаи викторина *</label>
                    <select class="form-select" id="id_quiz_mode" name="quiz_mode" required>
                        <option value="individual" selected>Индивидуалӣ</option>
                        <option value="group">Гурӯҳӣ</option>
                    </select>
                </div>
            </div>
            
            <!-- Description -->
            <div class="mb-3">
                <label for="id_description" class="form-label fw-bold">Тавсифи викторина</label>
                <textarea class="form-control" id="id_description" name="description" 
                          rows="3" placeholder="Тавсифи викторинаро дар ин ҷо нависед..."></textarea>
                <div class="form-text">Тавсифи муфассал ба донишҷӯён кӯмак мекунад, ки чӣ чизҳоро интизор шаванд</div>
            </div>
            
            <!-- Level Settings -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="id_level_type" class="form-label fw-bold">Навъи сатҳ *</label>
                    <select class="form-select" id="id_level_type" name="level_type" required>
                        <option value="school" selected>Мактаб</option>
                        <option value="university">Донишгоҳ</option>
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label for="id_start_level" class="form-label fw-bold">Сатҳи оғоз *</label>
                    <input type="number" class="form-control" id="id_start_level" 
                           name="start_level" min="1" max="20" value="1" required>
                </div>
                
                <div class="col-md-4">
                    <label for="id_end_level" class="form-label fw-bold">Сатҳи анҷом *</label>
                    <input type="number" class="form-control" id="id_end_level" 
                           name="end_level" min="1" max="20" value="10" required>
                </div>
            </div>
            
            <!-- Time Settings -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="id_start_time" class="form-label fw-bold">Вақти оғоз *</label>
                    <input type="datetime-local" class="form-control" 
                           id="id_start_time" name="start_time" required>
                </div>
                
                <div class="col-md-6">
                    <label for="id_end_time" class="form-label fw-bold">Вақти анҷом *</label>
                    <input type="datetime-local" class="form-control" 
                           id="id_end_time" name="end_time" required>
                </div>
            </div>
            
            <!-- Time Limit -->
            <div class="mb-3">
                <label for="id_duration" class="form-label fw-bold">Мӯҳлати вақт (дақиқа) *</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="id_duration" 
                           name="duration" min="1" max="180" value="30" required>
                    <span class="input-group-text">дақиқа</span>
                </div>
                <div class="form-text">Муқаррар кардани мӯҳлати вақт барои иҷрои викторина</div>
            </div>
            
            <!-- Navigation -->
            <div class="d-flex justify-content-between">
                <div></div>
                <button type="button" class="btn btn-primary" onclick="goToStep(2)">
                    Ба қадами навбатӣ <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
        
        <!-- Step 2: Questions -->
        <div class="form-section" id="step2-content" style="display: none;">
            <div class="form-section-header">
                <h4 class="fw-bold text-primary">
                    <i class="fas fa-question-circle me-2"></i>
                    Саволҳо
                </h4>
                <p class="text-muted mb-0">Саволҳои викторинаро илова кунед</p>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Шумо метавонед саволҳо пас аз эҷоди викторина илова кунед. Барои идома кардан тугмаи "Захира кардан"-ро пахш кунед.
            </div>
            
            <!-- Simple Question Form (optional) -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Саволи аввал (ихтиёрӣ)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Матни савол</label>
                        <textarea class="form-control" name="question_text" rows="3" 
                                  placeholder="Матни саволи аввалро дар ин ҷо нависед..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ҳаққҳо</label>
                        <input type="number" class="form-control" name="question_points" 
                               min="1" max="100" value="10">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ҷавобҳо</label>
                        <div class="mb-2">
                            <input type="text" class="form-control mb-2" name="answer_1" 
                                   placeholder="Ҷавоби 1">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct_answer" value="1">
                                <label class="form-check-label">Ин ҷавоб дуруст аст</label>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <input type="text" class="form-control mb-2" name="answer_2" 
                                   placeholder="Ҷавоби 2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct_answer" value="2">
                                <label class="form-check-label">Ин ҷавоб дуруст аст</label>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <input type="text" class="form-control mb-2" name="answer_3" 
                                   placeholder="Ҷавоби 3 (ихтиёрӣ)">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct_answer" value="3">
                                <label class="form-check-label">Ин ҷавоб дуруст аст</label>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <input type="text" class="form-control mb-2" name="answer_4" 
                                   placeholder="Ҷавоби 4 (ихтиёрӣ)">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="correct_answer" value="4">
                                <label class="form-check-label">Ин ҷавоб дуруст аст</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)">
                    <i class="fas fa-arrow-left me-2"></i> Ба қадами қаблӣ
                </button>
                <button type="button" class="btn btn-primary" onclick="goToStep(3)">
                    Ба қадами навбатӣ <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
        
        <!-- Step 3: Settings and Submit -->
        <div class="form-section" id="step3-content" style="display: none;">
            <div class="form-section-header">
                <h4 class="fw-bold text-primary">
                    <i class="fas fa-cog me-2"></i>
                    Танзимот ва тасдиқ
                </h4>
                <p class="text-muted mb-0">Танзимоти ниҳоии викторинаро муқаррар кунед</p>
            </div>
            
            <!-- Attempts and Passing -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label for="id_max_attempts" class="form-label fw-bold">Максимум кӯшишҳо *</label>
                    <input type="number" class="form-control" id="id_max_attempts" 
                           name="max_attempts" min="1" value="1" required>
                    <div class="form-text">Шумораи максималии иҷрои викторина</div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="id_pass_percentage" class="form-label fw-bold">Фоизи гузариш *</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="id_pass_percentage" 
                               name="pass_percentage" min="0" max="100" value="60" required>
                        <span class="input-group-text">%</span>
                    </div>
                    <div class="form-text">Миқдори минималии барои гузаштан аз викторина</div>
                </div>
            </div>
            
            <!-- Status Selection -->
            <div class="mb-4">
                <label class="form-label fw-bold">Статуси викторина *</label>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="status_draft" value="draft" checked>
                            <label class="form-check-label fw-bold" for="status_draft">
                                <i class="fas fa-save me-2 text-secondary"></i>Нопурра
                            </label>
                            <div class="form-text">Викторина захира карда мешавад ва омода кардани саволҳо идома меёбад</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="status_active" value="active">
                            <label class="form-check-label fw-bold" for="status_active">
                                <i class="fas fa-play-circle me-2 text-success"></i>Фаъол
                            </label>
                            <div class="form-text">Викторина фаъол карда мешавад ва корбарон метавонанд иҷро кунанд</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quiz Preview -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Пешнамоиши викторина</h5>
                </div>
                <div class="card-body">
                    <div id="quizPreview">
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Пешнамоиш омода карда мешавад...</span>
                            </div>
                            <p class="mt-3">Пешнамоиш омода карда мешавад...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Final Actions -->
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Пас аз эҷоди викторина, шумо метавонед саволҳои иловагӣ илова кунед ё онро таҳрир кунед.
            </div>
            
            <!-- Navigation and Submit -->
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
                    <i class="fas fa-arrow-left me-2"></i> Ба қадами қаблӣ
                </button>
                
                <div class="btn-group">
                    <button type="submit" name="save_draft" class="btn btn-outline-primary">
                        <i class="fas fa-save me-2"></i> Захираи нопурра
                    </button>
                    <button type="submit" name="publish" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i> Эҷод ва нашр
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;

// Navigation between steps
function goToStep(step) {
    // Validate current step before proceeding
    if (step > currentStep && !validateStep(currentStep)) {
        return;
    }
    
    // Hide all steps
    for (let i = 1; i <= 3; i++) {
        $(`#step${i}-content`).hide();
        $(`#step${i}`).removeClass('active completed');
    }
    
    // Show selected step
    $(`#step${step}-content`).show();
    
    // Update step indicators
    for (let i = 1; i < step; i++) {
        $(`#step${i}`).addClass('completed');
    }
    $(`#step${step}`).addClass('active');
    
    currentStep = step;
    
    // Update preview if on step 3
    if (step === 3) {
        updatePreview();
    }
}

// Step validation
function validateStep(step) {
    switch(step) {
        case 1:
            const title = $('#id_title').val().trim();
            const startLevel = $('#id_start_level').val();
            const endLevel = $('#id_end_level').val();
            const startTime = $('#id_start_time').val();
            const endTime = $('#id_end_time').val();
            const duration = $('#id_duration').val();
            
            if (!title) {
                alert('Лутфан унвони викторинаро ворид кунед');
                $('#id_title').focus();
                return false;
            }
            
            if (parseInt(startLevel) > parseInt(endLevel)) {
                alert('Сатҳи оғоз набояд аз сатҳи анҷом зиёд бошад');
                $('#id_start_level').focus();
                return false;
            }
            
            if (!startTime || !endTime) {
                alert('Лутфан вақтҳои оғоз ва анҷомро муайян кунед');
                return false;
            }
            
            // Validate times
            const startDate = new Date(startTime);
            const endDate = new Date(endTime);
            if (startDate >= endDate) {
                alert('Вақти анҷом бояд баъд аз вақти оғоз бошад');
                return false;
            }
            
            if (duration < 1 || duration > 180) {
                alert('Мӯҳлати вақт бояд байни 1 то 180 дақиқа бошад');
                $('#id_duration').focus();
                return false;
            }
            
            return true;
            
        case 2:
            // No validation required for questions (they're optional)
            return true;
            
        case 3:
            const maxAttempts = $('#id_max_attempts').val();
            const passPercentage = $('#id_pass_percentage').val();
            
            if (maxAttempts < 1) {
                alert('Максимум кӯшишҳо бояд камаш 1 бошад');
                $('#id_max_attempts').focus();
                return false;
            }
            
            if (passPercentage < 0 || passPercentage > 100) {
                alert('Фоизи гузариш бояд байни 0 то 100 бошад');
                $('#id_pass_percentage').focus();
                return false;
            }
            
            return true;
    }
    
    return true;
}

// Update preview
function updatePreview() {
    const title = $('#id_title').val() || 'Викторинаи нав';
    const description = $('#id_description').val() || 'Тавсиф вуҷуд надорад';
    const subject = $('#id_subject option:selected').text() || 'Без фан';
    const quizMode = $('#id_quiz_mode option:selected').text();
    const levelType = $('#id_level_type option:selected').text();
    const startLevel = $('#id_start_level').val();
    const endLevel = $('#id_end_level').val();
    const duration = $('#id_duration').val() || '0';
    const startTime = $('#id_start_time').val() ? new Date($('#id_start_time').val()).toLocaleString() : 'Муайян нашуда';
    const endTime = $('#id_end_time').val() ? new Date($('#id_end_time').val()).toLocaleString() : 'Муайян нашуда';
    const maxAttempts = $('#id_max_attempts').val();
    const passPercentage = $('#id_pass_percentage').val();
    const status = $('input[name="status"]:checked').val();
    const statusText = status === 'active' ? 'Фаъол' : 'Нопурра';
    
    const previewHtml = `
        <div class="preview-header mb-4">
            <h4 class="fw-bold">${title}</h4>
            <p class="text-muted mb-2">${description}</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-2">
                        <strong>Фан:</strong> ${subject}
                    </div>
                    <div class="mb-2">
                        <strong>Реҷа:</strong> ${quizMode}
                    </div>
                    <div class="mb-2">
                        <strong>Навъи сатҳ:</strong> ${levelType}
                    </div>
                    <div class="mb-2">
                        <strong>Сатҳҳо:</strong> ${startLevel} - ${endLevel}
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-2">
                        <strong>Вақти оғоз:</strong> ${startTime}
                    </div>
                    <div class="mb-2">
                        <strong>Вақти анҷом:</strong> ${endTime}
                    </div>
                    <div class="mb-2">
                        <strong>Мӯҳлати вақт:</strong> ${duration} дақиқа
                    </div>
                    <div class="mb-2">
                        <strong>Кӯшишҳо:</strong> ${maxAttempts} маротиба
                    </div>
                    <div class="mb-2">
                        <strong>Фоизи гузариш:</strong> ${passPercentage}%
                    </div>
                </div>
            </div>
            
            <div class="alert alert-${status === 'active' ? 'success' : 'info'} mt-3">
                <i class="fas fa-${status === 'active' ? 'play-circle' : 'save'} me-2"></i>
                Статус: <strong>${statusText}</strong>
            </div>
        </div>
    `;
    
    $('#quizPreview').html(previewHtml);
}

// Initialize date/time inputs
$(document).ready(function() {
    const now = new Date();
    const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
    const nextWeek = new Date(tomorrow.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    $('#id_start_time').val(formatDateTime(tomorrow));
    $('#id_end_time').val(formatDateTime(nextWeek));
    
    function formatDateTime(date) {
        return date.toISOString().slice(0, 16);
    }
    
    // Auto-calculate end level if start level changes
    $('#id_start_level').on('change', function() {
        const startLevel = parseInt($(this).val());
        const endLevel = parseInt($('#id_end_level').val());
        
        if (startLevel > endLevel) {
            $('#id_end_level').val(startLevel);
        }
    });
    
    // Form submission
    $('#quizCreateForm').submit(function(e) {
        if (!validateStep(currentStep)) {
            e.preventDefault();
            return false;
        }
        
        // Ensure we're on the final step
        if (currentStep !== 3) {
            e.preventDefault();
            goToStep(3);
            return false;
        }
        
        // Show loading
        $('button[type="submit"]').prop('disabled', true).html(
            '<i class="fas fa-spinner fa-spin me-2"></i>Эҷод карда истодааст...'
        );
        
        return true;
    });
    
    // Initialize preview
    updatePreview();
});
</script>
{% endblock %}