<!-- templates/quiz_create.html -->
{% extends "base.html" %}

{% block title %}Эҷоди викторинаи нав{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Дашборд</a></li>
            <li class="breadcrumb-item"><a href="{% url 'quiz_list' %}">Викторинаҳо</a></li>
            <li class="breadcrumb-item active">Эҷоди нав</li>
        </ol>
    </nav>
    
    <h1 class="display-5 fw-bold mb-4">
        <i class="fas fa-plus-circle me-2 text-primary"></i>
        Эҷоди викторинаи нав
    </h1>
    
    <div class="row">
        <!-- Main Form -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="post" id="quizForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Basic Info -->
                        <div class="mb-4">
                            <h5 class="mb-3 border-bottom pb-2">
                                <i class="fas fa-info-circle me-2 text-primary"></i>
                                Маълумоти асосӣ
                            </h5>
                            
                            <div class="mb-3">
                                <label for="id_title" class="form-label fw-bold">Унвони викторина</label>
                                <input type="text" class="form-control form-control-lg" 
                                       id="id_title" name="title" required
                                       placeholder="Масалан: Тести математикаи ҳисоббарор">
                            </div>
                            
                            <div class="mb-3">
                                <label for="id_description" class="form-label fw-bold">Тавсиф</label>
                                <textarea class="form-control" id="id_description" name="description" 
                                          rows="3" placeholder="Тавсифи мухтасар оид ба викторина"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_subject" class="form-label fw-bold">Фан</label>
                                    <select class="form-select" id="id_subject" name="subject" required>
                                        <option value="" selected disabled>Фанро интихоб кунед</option>
                                        {% for subject in subjects %}
                                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_duration" class="form-label fw-bold">Мӯҳлати вақт (дақиқа)</label>
                                    <input type="number" class="form-control" id="id_duration" 
                                           name="duration" min="1" max="180" value="30" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_difficulty" class="form-label fw-bold">Мураккабӣ</label>
                                    <select class="form-select" id="id_difficulty" name="difficulty">
                                        <option value="easy">Осон</option>
                                        <option value="medium" selected>Миёна</option>
                                        <option value="hard">Душвор</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_max_attempts" class="form-label fw-bold">Маҳдудияти иҷро</label>
                                    <input type="number" class="form-control" id="id_max_attempts" 
                                           name="max_attempts" min="0" value="0">
                                    <small class="text-muted">0 барои номаҳдуд</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Access Settings -->
                        <div class="mb-4">
                            <h5 class="mb-3 border-bottom pb-2">
                                <i class="fas fa-lock me-2 text-primary"></i>
                                Танзимоти дастрасӣ
                            </h5>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           id="id_is_public" name="is_public" checked>
                                    <label class="form-check-label fw-bold" for="id_is_public">
                                        Викторинаи оммавӣ
                                    </label>
                                    <small class="text-muted d-block">
                                        Агар фаъол бошад, ҳама корбарон метавонанд викторинаро иҷро кунанд
                                    </small>
                                </div>
                            </div>
                            
                            <div class="mb-3" id="accessGroups" style="display: none;">
                                <label class="form-label fw-bold">Гурӯҳҳои дастрасӣ</label>
                                <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    {% for group in groups %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="allowed_groups" value="{{ group.id }}" 
                                               id="group{{ group.id }}">
                                        <label class="form-check-label" for="group{{ group.id }}">
                                            {{ group.name }}
                                            <small class="text-muted">({{ group.members.count }} аъзо)</small>
                                        </label>
                                    </div>
                                    {% empty %}
                                    <p class="text-muted mb-0">Гурӯҳ вуҷуд надорад</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Schedule Settings -->
                        <div class="mb-4">
                            <h5 class="mb-3 border-bottom pb-2">
                                <i class="fas fa-calendar-alt me-2 text-primary"></i>
                                Барномаи вақт
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="id_start_time" class="form-label fw-bold">Вақти оғоз</label>
                                    <input type="datetime-local" class="form-control" 
                                           id="id_start_time" name="start_time">
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="id_end_time" class="form-label fw-bold">Вақти поён</label>
                                    <input type="datetime-local" class="form-control" 
                                           id="id_end_time" name="end_time">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'quiz_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i> Бекор кардан
                            </a>
                            
                            <div class="btn-group">
                                <button type="submit" name="save_draft" class="btn btn-outline-primary">
                                    <i class="fas fa-save me-2"></i> Захираи нопурра
                                </button>
                                <button type="submit" name="publish" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i> Эҷод ва нашр
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Tips Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>
                        Маслиҳатҳо
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Унвон бояд муайян ва ҷолиб бошад
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Мӯҳлати вақтро мувофиқи миқдори саволҳо муайян кунед
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Викторинаҳои миёна 20-30 дақиқа давом мекунанд
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Пеш аз нашр, саволҳоро илова кунед
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2 text-primary"></i>
                        Амалҳои зуд
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'question_create' 0 %}" class="btn btn-outline-success">
                            <i class="fas fa-plus-circle me-2"></i> Саволи нав илова кунед
                        </a>
                        <button type="button" class="btn btn-outline-info" id="previewQuiz">
                            <i class="fas fa-eye me-2"></i> Пешнамоиш
                        </button>
                        <button type="button" class="btn btn-outline-warning" id="saveTemplate">
                            <i class="fas fa-copy me-2"></i> Захира кардан ҳамчун шаблон
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Пешнамоиши викторина</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <p>Лутфан интизор шавед, пешнамоиш омода карда мешавад...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control-lg {
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
}

.form-switch .form-check-input {
    width: 3em;
    height: 1.5em;
}

.border-bottom {
    border-bottom: 2px solid #dee2e6 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Toggle access groups based on public/private
    $('#id_is_public').change(function() {
        if ($(this).is(':checked')) {
            $('#accessGroups').slideUp();
        } else {
            $('#accessGroups').slideDown();
        }
    }).trigger('change');
    
    // Set default times
    const now = new Date();
    const startTime = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Tomorrow
    const endTime = new Date(startTime.getTime() + 7 * 24 * 60 * 60 * 1000); // Next week
    
    $('#id_start_time').val(formatDateTime(startTime));
    $('#id_end_time').val(formatDateTime(endTime));
    
    function formatDateTime(date) {
        return date.toISOString().slice(0, 16);
    }
    
    // Preview quiz
    $('#previewQuiz').click(function() {
        $('#previewModal').modal('show');
        
        // Simulate preview (in real app, this would be an AJAX call)
        const formData = $('#quizForm').serialize();
        $('#previewContent').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Омода карда мешавад...</span>
                </div>
                <p class="mt-3">Пешнамоиши викторина омода карда мешавад...</p>
            </div>
        `);
        
        setTimeout(function() {
            $('#previewContent').html(`
                <h4>${$('#id_title').val() || 'Викторинаи нав'}</h4>
                <p class="text-muted">${$('#id_description').val() || 'Тавсиф вуҷуд надорад'}</p>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Фан:</strong> ${$('#id_subject option:selected').text() || 'Муайян нашуда'}
                    </div>
                    <div class="col-6">
                        <strong>Вақт:</strong> ${$('#id_duration').val()} дақиқа
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Ин танҳо пешнамоиш аст. Барои эҷоди викторина, тугмаи "Эҷод ва нашр"-ро пахш кунед.
                </div>
            `);
        }, 1000);
    });
    
    // Save as template
    $('#saveTemplate').click(function() {
        if (confirm('Мехоҳед ин викторинаро ҳамчун шаблон захира кунед?')) {
            // In real app, this would be an AJAX call
            alert('Шаблон бомуваффақият захира шуд!');
        }
    });
    
    // Form validation
    $('#quizForm').submit(function(e) {
        const title = $('#id_title').val().trim();
        const duration = $('#id_duration').val();
        
        if (!title) {
            e.preventDefault();
            alert('Лутфан унвони викторинаро ворид кунед');
            $('#id_title').focus();
            return false;
        }
        
        if (duration < 1 || duration > 180) {
            e.preventDefault();
            alert('Мӯҳлати вақт бояд байни 1 то 180 дақиқа бошад');
            $('#id_duration').focus();
            return false;
        }
        
        return true;
    });
});
</script>
{% endblock %}